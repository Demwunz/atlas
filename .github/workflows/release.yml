name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-${{ matrix.target }}-cargo-release-

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build release binary
        if: ${{ !matrix.cross }}
        run: cargo build --release --target ${{ matrix.target }} --package atlas-cli

      - name: Build release binary (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }} --package atlas-cli

      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          BINARY_NAME="atlas"
          TAG="${GITHUB_REF#refs/tags/}"
          ARCHIVE="atlas-${TAG}-${{ matrix.target }}.tar.gz"
          cd target/${{ matrix.target }}/release
          tar czf "../../../${ARCHIVE}" "${BINARY_NAME}"
          cd ../../..
          shasum -a 256 "${ARCHIVE}" > "${ARCHIVE}.sha256"

      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $TAG = $env:GITHUB_REF -replace '^refs/tags/', ''
          $ARCHIVE = "atlas-${TAG}-${{ matrix.target }}.zip"
          Compress-Archive -Path "target/${{ matrix.target }}/release/atlas.exe" -DestinationPath $ARCHIVE
          $hash = (Get-FileHash $ARCHIVE -Algorithm SHA256).Hash.ToLower()
          "$hash  $ARCHIVE" | Out-File -Encoding ASCII "${ARCHIVE}.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: atlas-${{ matrix.target }}
          path: |
            atlas-*.tar.gz
            atlas-*.tar.gz.sha256
            atlas-*.zip
            atlas-*.zip.sha256

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/atlas-*.tar.gz
            artifacts/atlas-*.tar.gz.sha256
            artifacts/atlas-*.zip
            artifacts/atlas-*.zip.sha256

  publish-crates:
    name: Publish to crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Publish crates in dependency order
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          for crate in atlas-core atlas-scanner atlas-score atlas-treesit atlas-render atlas-index atlas-cli; do
            echo "Publishing ${crate}..."
            cargo publish -p "${crate}" --no-verify
            # Wait for crates.io to index the crate before publishing dependents
            sleep 30
          done

  homebrew:
    name: Update Homebrew tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Compute SHA256 hashes
        id: hashes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

          for target in aarch64-apple-darwin x86_64-apple-darwin x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu; do
            ARCHIVE="artifacts/atlas-${TAG}-${target}.tar.gz"
            HASH=$(sha256sum "${ARCHIVE}" | cut -d' ' -f1)
            KEY=$(echo "${target}" | tr '-' '_')
            echo "sha256_${KEY}=${HASH}" >> "$GITHUB_OUTPUT"
          done

      - name: Update Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/demwunz/homebrew-tap.git" homebrew-tap
          cd homebrew-tap

          cat > Formula/atlas.rb << 'FORMULA'
          # Homebrew formula for Atlas â€” auto-generated by release workflow.
          #
          # Usage:
          #   brew tap demwunz/tap
          #   brew install atlas

          class Atlas < Formula
            desc "Fast codebase indexer and file selector for LLMs"
            homepage "https://github.com/demwunz/atlas"
            license "MIT"
            version "VERSION_PLACEHOLDER"

            on_macos do
              on_arm do
                url "https://github.com/demwunz/atlas/releases/download/vVERSION_PLACEHOLDER/atlas-vVERSION_PLACEHOLDER-aarch64-apple-darwin.tar.gz"
                sha256 "SHA256_AARCH64_APPLE_DARWIN"
              end

              on_intel do
                url "https://github.com/demwunz/atlas/releases/download/vVERSION_PLACEHOLDER/atlas-vVERSION_PLACEHOLDER-x86_64-apple-darwin.tar.gz"
                sha256 "SHA256_X86_64_APPLE_DARWIN"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/demwunz/atlas/releases/download/vVERSION_PLACEHOLDER/atlas-vVERSION_PLACEHOLDER-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "SHA256_AARCH64_UNKNOWN_LINUX_GNU"
              end

              on_intel do
                url "https://github.com/demwunz/atlas/releases/download/vVERSION_PLACEHOLDER/atlas-vVERSION_PLACEHOLDER-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "SHA256_X86_64_UNKNOWN_LINUX_GNU"
              end
            end

            def install
              bin.install "atlas"
            end

            test do
              assert_match "atlas v#{version}", shell_output("#{bin}/atlas --version 2>&1", 0).strip
              output = shell_output("#{bin}/atlas describe --format json 2>&1", 0)
              json = JSON.parse(output)
              assert_equal "atlas", json["name"]
            end
          end
          FORMULA

          # Replace placeholders with actual values
          sed -i "s/VERSION_PLACEHOLDER/${{ steps.hashes.outputs.version }}/g" Formula/atlas.rb
          sed -i "s/SHA256_AARCH64_APPLE_DARWIN/${{ steps.hashes.outputs.sha256_aarch64_apple_darwin }}/g" Formula/atlas.rb
          sed -i "s/SHA256_X86_64_APPLE_DARWIN/${{ steps.hashes.outputs.sha256_x86_64_apple_darwin }}/g" Formula/atlas.rb
          sed -i "s/SHA256_AARCH64_UNKNOWN_LINUX_GNU/${{ steps.hashes.outputs.sha256_aarch64_unknown_linux_gnu }}/g" Formula/atlas.rb
          sed -i "s/SHA256_X86_64_UNKNOWN_LINUX_GNU/${{ steps.hashes.outputs.sha256_x86_64_unknown_linux_gnu }}/g" Formula/atlas.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/atlas.rb
          git commit -m "atlas ${{ steps.hashes.outputs.version }}"
          git push
